name: Auto Multi-Site Scheduler

on:
  schedule:
    - cron: "0 5 * * *"   # åŒ—äº¬æ—¶é—´13:00ï¼ˆGitHub ä½¿ç”¨ UTCï¼‰
    - cron: "10 5 * * *"  # åŒ—äº¬æ—¶é—´13:10
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘

env:
  DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}
  DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL }}
  DIFY_SITES_CONF: ${{ secrets.DIFY_SITES_CONF }}  # ğŸ‘‰ ç¡®ä¿ä»“åº“ Secrets åç§°ä¸€è‡´

jobs:
  Run-Dify-Workflows:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y jq curl

      - name: è§£æå¹¶éªŒè¯é…ç½®
        id: parse-config
        shell: bash
        run: |
          set -euo pipefail

          # ç»™ BASE_URL é»˜è®¤å€¼ï¼ˆè‹¥æœªé…ç½® Secretsï¼‰
          : "${DIFY_BASE_URL:=https://api.dify.ai}"

          CURRENT_CRON="${{ github.event.schedule || 'manual' }}"
          echo "å½“å‰è§¦å‘çš„å®šæ—¶è§„åˆ™: $CURRENT_CRON"

          # ------- è¯»å–å¹¶æ¸…æ´— Secrets ä¸­çš„ JSON -------
          RAW="${DIFY_SITES_CONF}"

          # å»æ‰å¯èƒ½çš„ä¸‰å¼•å·ä»£ç å—åŠé¦–å°¾å¤šä½™å¼•å·
          SANITIZED="$(printf '%s' "$RAW" \
            | sed -E 's/^[[:space:]]*```(json|JSON)?[[:space:]]*//; s/[[:space:]]*```[[:space:]]*$//' \
            | sed -E 's/^[[:space:]]*'\''(.*)'\''[[:space:]]*$/\1/' \
            | sed -E 's/^[[:space:]]*"(.*)"[[:space:]]*$/\1/' \
          )"

          # å¦‚æœæ˜¯å¯¹è±¡åŒ…è£… { "tasks": [...] }ï¼ŒæŠ½å– tasks
          if echo "$SANITIZED" | jq -e '.tasks | type=="array"' >/dev/null 2>&1; then
            SANITIZED="$(echo "$SANITIZED" | jq -c '.tasks')"
          fi

          # æ ¡éªŒä¸º JSON æ•°ç»„
          if ! echo "$SANITIZED" | jq -e 'type=="array"' >/dev/null 2>&1; then
            echo "âŒ DIFY_SITES_CONF ä¸æ˜¯åˆæ³•çš„ JSON æ•°ç»„ï¼Œè¯·æ£€æŸ¥ Secrets å€¼ã€‚"
            echo "æç¤ºï¼šSecrets é‡Œåº”ç›´æ¥ä¿å­˜ä»¥ [ å¼€å¤´ã€ ] ç»“å°¾çš„çº¯æ•°ç»„ï¼Œæ— å¼•å·ã€æ—  ```json åŒ…è£¹ã€‚"
            exit 1
          fi

          # ------- åŒ¹é…å½“å‰ cronï¼ˆæ”¯æŒ string æˆ– arrayï¼‰-------
          MATCHED_CONFIG="$(echo "$SANITIZED" | jq -c --arg cron "$CURRENT_CRON" '
            .[] | select(
              (.cron|type=="string" and .cron==$cron) or
              (.cron|type=="array" and index($cron))
            )
          ')"

          if [ -z "$MATCHED_CONFIG" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸å½“å‰ cron åŒ¹é…çš„é…ç½®: $CURRENT_CRON"
            echo "å¯ç”¨çš„ cron åˆ—è¡¨ï¼š"
            echo "$SANITIZED" | jq -r '
              .[] | (.name // "æœªå‘½å") + " => " +
              (if (.cron|type=="string") then .cron else (.cron|join(", ")) end)
            '
            exit 1
          fi

          WORKFLOW_ID="$(echo "$MATCHED_CONFIG" | jq -r '.workflow_id')"
          INPUTS_JSON="$(echo "$MATCHED_CONFIG" | jq -c '.inputs // {}')"

          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "âŒ å·¥ä½œæµ ID (workflow_id) ä¸èƒ½ä¸ºç©º"
            exit 1
          fi

          {
            echo "workflow_id=$WORKFLOW_ID"
            echo "inputs=$INPUTS_JSON"
          } >> "$GITHUB_OUTPUT"

          echo "âœ… åŒ¹é…åˆ°ç½‘ç«™: $(echo "$MATCHED_CONFIG" | jq -r '.name // "æœªå‘½åç½‘ç«™"')"

      - name: è§¦å‘ Dify å·¥ä½œæµ
        shell: bash
        run: |
          set -euo pipefail
          : "${DIFY_BASE_URL:=https://api.dify.ai}"

          WORKFLOW_ID="${{ steps.parse-config.outputs.workflow_id }}"
          INPUTS='${{ steps.parse-config.outputs.inputs }}'

          echo "ğŸš€ è°ƒç”¨å·¥ä½œæµ: $WORKFLOW_ID"
          echo "ğŸ“¦ è¾“å…¥å‚æ•°: $INPUTS"

          curl -sS -X POST "$DIFY_BASE_URL/v1/workflows/$WORKFLOW_ID/execute" \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "{\"inputs\": $INPUTS}" \
            | jq '.'
