name: Auto Multi-Site Scheduler

on:
  schedule:
    - cron: "0 5 * * *"   # åŒ—äº¬æ—¶é—´13:00
    - cron: "10 5 * * *"  # åŒ—äº¬æ—¶é—´13:10
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘è°ƒè¯•

env:
  DIFY_TOKENS: ${{ secrets.DIFY_TOKENS }}
  DIFY_BASE_URL: ${{ secrets.DIFY_BASE_URL || 'https://api.dify.ai' }}
  DIFY_SITES_CONF: ${{ secrets.DIFY_SITES_CONF }} # âœ… ç¡®è®¤æ‹¼å†™ä¸€è‡´

jobs:
  Run-Dify-Workflows:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… Node.js ç¯å¢ƒ
        run: |
          sudo apt update -y
          sudo apt install -y nodejs npm jq
          npm install -g yarn
          echo "Node.js ç‰ˆæœ¬: $(node -v)"

      - name: è§£æå¹¶éªŒè¯é…ç½®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
        id: parse-config
        run: |
          CURRENT_CRON="${{ github.event.schedule || 'manual' }}"
          echo "å½“å‰è§¦å‘çš„å®šæ—¶è§„åˆ™: $CURRENT_CRON"

          # 1. å¼ºåˆ¶éªŒè¯ JSON æ•°ç»„
          if ! echo "$DIFY_SITES_CONF" | jq -e 'type == "array"' > /dev/null 2>&1; then
            echo "âŒ DIFY_SITES_CONF å¿…é¡»æ˜¯ JSON æ•°ç»„ï¼ˆç”¨ [] åŒ…è£¹ï¼‰ï¼Œå½“å‰æ ¼å¼é”™è¯¯"
            echo "$DIFY_SITES_CONF" | cut -c 1-200
            exit 1
          fi

          # 2. éªŒè¯æ•°ç»„ä¸ä¸ºç©º
          SITE_COUNT=$(echo "$DIFY_SITES_CONF" | jq '. | length')
          if [ "$SITE_COUNT" -eq 0 ]; then
            echo "âŒ DIFY_SITES_CONF æ•°ç»„ä¸ºç©ºï¼Œè¯·è‡³å°‘é…ç½®ä¸€ä¸ªç½‘ç«™"
            exit 1
          fi

          # 3. æŸ¥æ‰¾åŒ¹é…çš„ç½‘ç«™é…ç½®
          MATCHED_CONFIG=$(echo "$DIFY_SITES_CONF" | jq -c --arg cron "$CURRENT_CRON" '.[] | select(.cron == $cron)')
          if [ -z "$MATCHED_CONFIG" ] || [ "$MATCHED_CONFIG" = "null" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä¸å½“å‰ cron åŒ¹é…çš„é…ç½®: $CURRENT_CRON"
            echo "å¯ç”¨çš„ cron é…ç½®:"
            echo "$DIFY_SITES_CONF" | jq -r '.[] | .cron'
            exit 1
          fi

          # 4. æå–å‚æ•°
          WORKFLOW_ID=$(echo "$MATCHED_CONFIG" | jq -r '.workflow_id')
          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "âŒ å·¥ä½œæµ ID (workflow_id) ä¸èƒ½ä¸ºç©º"
            exit 1
          fi

          echo "workflow_id=$WORKFLOW_ID" >> $GITHUB_OUTPUT
          echo "inputs=$(echo "$MATCHED_CONFIG" | jq -c '.inputs')" >> $GITHUB_OUTPUT
          echo "âœ… åŒ¹é…åˆ°ç½‘ç«™: $(echo "$MATCHED_CONFIG" | jq -r '.name // "æœªå‘½åç½‘ç«™"')"

      - name: è§¦å‘ Dify å·¥ä½œæµ
        run: |
          WORKFLOW_ID="${{ steps.parse-config.outputs.workflow_id }}"
          INPUTS='${{ steps.parse-config.outputs.inputs }}'

          echo "ğŸš€ å¼€å§‹è°ƒç”¨å·¥ä½œæµ: $WORKFLOW_ID"
          echo "ğŸ“¦ è¾“å…¥å‚æ•°: $INPUTS"

          curl -X POST "$DIFY_BASE_URL/v1/workflows/$WORKFLOW_ID/execute" \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "{\"inputs\": $INPUTS}"
