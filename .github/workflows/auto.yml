name: Run Dify Workflows

on:
  workflow_dispatch:  # 手动触发
  schedule:           # 定时触发
    - cron: "0 5 * * *"
    - cron: "10 5 * * *"

jobs:
  run-dify:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库
        uses: actions/checkout@v3

      - name: 安装依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: 解析并验证配置
        id: parse
        run: |
          set -euo pipefail

          : "${DIFY_BASE_URL:=https://api.dify.ai}"

          # 当前触发规则，GitHub 会传递 cron，否则为 manual
          CURRENT_CRON="${{ github.event.schedule || 'manual' }}"
          echo "当前触发的定时规则: $CURRENT_CRON"

          RAW="$DIFY_SITES_CONF"

          # 清洗配置（去掉可能的 ```json 包裹和引号）
          SANITIZED="$(printf '%s' "$RAW" \
            | sed -E 's/^[[:space:]]*```(json|JSON)?[[:space:]]*//; s/[[:space:]]*```[[:space:]]*$//' \
            | sed -E "s/^[[:space:]]*'(.*)'[[:space:]]*$/\1/" \
            | sed -E 's/^[[:space:]]*"(.*)"[[:space:]]*$/\1/' \
          )"

          # 支持 { "tasks": [ ... ] } 包裹
          if echo "$SANITIZED" | jq -e '.tasks | type=="array"' >/dev/null 2>&1; then
            SANITIZED="$(echo "$SANITIZED" | jq -c '.tasks')"
          fi

          # 校验为数组
          if ! echo "$SANITIZED" | jq -e 'type=="array"' >/dev/null 2>&1; then
            echo "❌ DIFY_SITES_CONF 不是合法的 JSON 数组"
            exit 1
          fi

          # 匹配 cron
          MATCHED_CONFIG="$(echo "$SANITIZED" | jq -c --arg cron "$CURRENT_CRON" '
            .[] | select(
              (.cron|type=="string" and .cron==$cron) or
              (.cron|type=="array" and index($cron))
            )
          ')"

          if [ -z "$MATCHED_CONFIG" ]; then
            echo "❌ 未找到与当前 cron 匹配的配置: $CURRENT_CRON"
            echo "可用的 cron 列表："
            echo "$SANITIZED" | jq -r '
              .[] | (.name // "未命名") + " => " +
              (if (.cron|type=="string") then .cron else (.cron|join(", ")) end)
            '
            exit 1
          fi

          WORKFLOW_ID="$(echo "$MATCHED_CONFIG" | jq -r '.workflow_id')"
          INPUTS_JSON="$(echo "$MATCHED_CONFIG" | jq -c '.inputs // {}')"

          if [ -z "$WORKFLOW_ID" ] || [ "$WORKFLOW_ID" = "null" ]; then
            echo "❌ 工作流 ID (workflow_id) 不能为空"
            exit 1
          fi

          {
            echo "workflow_id=$WORKFLOW_ID"
            echo "inputs=$INPUTS_JSON"
          } >> "$GITHUB_OUTPUT"

          echo "✅ 匹配到网站: $(echo "$MATCHED_CONFIG" | jq -r '.name // "未命名网站"')"

      - name: 触发 Dify Workflow
        run: |
          curl -X POST "$DIFY_BASE_URL/v1/workflows/${{ steps.parse.outputs.workflow_id }}/execute" \
            -H "Authorization: Bearer $DIFY_TOKENS" \
            -H "Content-Type: application/json" \
            -d "${{ steps.parse.outputs.inputs }}"
